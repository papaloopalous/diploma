<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º fflate —á–µ—Ä–µ–∑ CDN -->
  <script src="https://unpkg.com/fflate@0.7.4/umd/index.js"></script>
</head>
<body>
  <h1>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è</h1>

  <label for="studentID">Student ID (UUID):</label><br />
  <input type="text" id="studentID" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, cc1a56e2-0f5f-4a17-9f5e-caf58f2c62e3"><br />

  <label for="taskName">Task Name:</label><br />
  <input type="text" id="taskName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—è —Ä–∞–±–æ—Ç–∞"><br />

  <label for="fileInput">–§–∞–π–ª (.docx):</label><br />
  <input type="file" id="fileInput" accept=".docx"><br><br>

  <button onclick="uploadFile()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

  <hr>

  <h2>üì• –°–∫–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h2>
  <label for="taskID">Task ID (UUID):</label><br />
  <input type="text" id="taskID" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, d4c3c8e2-..."><br><br>

  <button onclick="downloadFile()">üì• –°–∫–∞—á–∞—Ç—å</button>

  <script>
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–∞: 10 –ú–ë (10 * 1024 * 1024 –±–∞–π—Ç)
    const MAX_FILE_SIZE = 10 * 1024 * 1024;

    async function uploadFile() {
      const studentID = document.getElementById("studentID").value.trim();
      const taskName = document.getElementById("taskName").value.trim();
      const fileInput = document.getElementById("fileInput");

      if (!studentID || !taskName || fileInput.files.length === 0) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
        return;
      }

      const file = fileInput.files[0];

      if (file.size > MAX_FILE_SIZE) {
        alert("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∏–º–∏—Ç 10 –ú–ë");
        return;
      }

      let arrayBuffer;
      try {
        arrayBuffer = await file.arrayBuffer();
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err.message);
        return;
      }

      const uint8 = new Uint8Array(arrayBuffer);
      let compressed;
      try {
        compressed = fflate.gzipSync(uint8);
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è —Ñ–∞–π–ª–∞: " + err.message);
        return;
      }

      try {
        const response = await fetch("/upload-task", {
          method: "POST",
          headers: {
            "Content-Type": "application/octet-stream",
            "studentID": studentID,
            "taskName": taskName,
            "fileName": file.name
          },
          body: compressed
        });
        const text = await response.text();
        alert("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:\n" + text);
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞: " + err.message);
      }
    }

    async function downloadFile() {
      const taskID = document.getElementById("taskID").value.trim();
      if (!taskID) {
        alert("–í–≤–µ–¥–∏—Ç–µ taskID");
        return;
      }

      try {
        const res = await fetch(`/download-task?taskID=${encodeURIComponent(taskID)}`);
        if (!res.ok) {
          const msg = await res.text();
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:\n" + msg);
          return;
        }

        const fileName = getFileNameFromContentDisposition(res.headers.get("Content-Disposition")) || "file.docx";
        const compressedBuffer = await res.arrayBuffer();
        const compressed = new Uint8Array(compressedBuffer);

        let uncompressed;
        try {
          uncompressed = fflate.gunzipSync(compressed);
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ —Ñ–∞–π–ª–∞: " + err.message);
          return;
        }

        const blob = new Blob([uncompressed]);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + err.message);
      }
    }

    function getFileNameFromContentDisposition(header) {
      if (!header) return null;
      const match = header.match(/filename="?([^"]+)"?/);
      return match ? match[1] : null;
    }
  </script>
</body>
</html>
