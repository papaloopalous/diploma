<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Личный кабинет</title>
  <style>
    .section { display: none; }
    #menuTeacher, #menuStudent {
      margin-bottom: 10px;
    }
    #logoutBtn {
      float: right;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Главная страница</h1>
  <button id="logoutBtn">Выйти</button>

  <nav>
    <!-- Меню для преподавателя -->
    <div id="menuTeacher" style="display:none;">
      <button onclick="showSection('studentsSection')">Мои студенты</button>
      <button onclick="showSection('tasksSection')">Мои задания</button>
      <button onclick="showSection('requestsSection')">Мои заявки</button>
      <button onclick="showSection('profileSection')">Мой профиль</button>
    </div>

    <!-- Меню для студента -->
    <div id="menuStudent" style="display:none;">
      <button onclick="showSection('allTeachersSection')">Все преподаватели</button>
      <button onclick="showSection('myTeachersSection')">Мои преподаватели</button>
      <button onclick="showSection('tasksSection')">Мои задания</button>
      <button onclick="showSection('profileSection')">Мой профиль</button>
    </div>
  </nav>
  <hr/>

  <!-- Преподаватель -->
  <div id="studentsSection" class="section">
    <h2>Мои студенты</h2>
    <div id="studentsList"></div>
  </div>

  <div id="requestsSection" class="section">
    <h2>Мои заявки</h2>
    <div id="requestsList"></div>
  </div>

  <!-- Общая для всех: Задания -->
  <div id="tasksSection" class="section">
    <h2>Мои задания</h2>
    <div id="tasksList"></div>
  </div>

  <!-- Общая для всех: Профиль -->
  <div id="profileSection" class="section">
    <h2>Мой профиль</h2>
    <div id="profileInfo"></div>
  </div>

  <!-- Студент -->
  <div id="allTeachersSection" class="section">
    <h2>Все преподаватели</h2>
    <label>Поле для сортировки:</label>
    <select id="sortField">
      <option value="rating">Рейтинг</option>
      <option value="price">Цена</option>
    </select>
    <label>Порядок:</label>
    <select id="sortOrder">
      <option value="asc">По возрастанию</option>
      <option value="desc">По убыванию</option>
    </select>
    <button onclick="loadAllTeachers()">Применить</button>
    <div id="allTeachersList"></div>
  </div>

  <div id="myTeachersSection" class="section">
    <h2>Мои преподаватели</h2>
    <div id="myTeachersList"></div>
  </div>

  <script>
    // ======== КНОПКА «ВЫЙТИ» ========
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      fetch('/api/logout', {
        method: 'DELETE',
        credentials: 'include'
      })
      .then(res => {
        if (!res.ok) {
          return res.text().then(t => { throw new Error(t); });
        }
        window.location.href = '/';
      })
      .catch(err => alert('Ошибка выхода: ' + err.message));
    });

    // ======== ЧТЕНИЕ userRole (исправленный RegExp) ========
    function getCookie(name) {
      const matches = document.cookie.match(new RegExp(
        '(?:^|; )' + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'
      ));
      return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    const roleCookie = getCookie('userRole');
    console.log('[DEBUG] userRole from cookie =', roleCookie);

    if (roleCookie === 'teacher') {
      document.getElementById('menuTeacher').style.display = 'block';
    } else if (roleCookie === 'student') {
      document.getElementById('menuStudent').style.display = 'block';
    } else {
      // fallback
      document.getElementById('menuStudent').style.display = 'block';
    }

    // ======== ПЕРЕКЛЮЧЕНИЕ РАЗДЕЛОВ ========
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';

      if (id === 'studentsSection') loadStudents();
      else if (id === 'tasksSection') loadTasks();
      else if (id === 'requestsSection') loadRequests();
      else if (id === 'profileSection') loadProfile();
      else if (id === 'allTeachersSection') loadAllTeachers();
      else if (id === 'myTeachersSection') loadMyTeachers();
    }

    // ======== ПРЕПОДАВАТЕЛЬ: Мои студенты ========
    async function loadStudents() {
      try {
        const res = await fetch('/api/get-students', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        const users = await res.json();
        renderStudents(Array.isArray(users) ? users : []);
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    function renderStudents(users) {
      const container = document.getElementById('studentsList');
      container.innerHTML = '';
      if (!users.length) {
        container.textContent = 'Нет студентов';
        return;
      }
      users.forEach(u => {
        const div = document.createElement('div');
        div.textContent = `ФИО: ${u.fio}, Возраст: ${u.age}`;

        const btnTask = document.createElement('button');
        btnTask.textContent = 'Добавить задание';
        btnTask.onclick = () => addTaskForStudent(u);

        const btnChat = document.createElement('button');
        btnChat.textContent = 'Начать чат';
        btnChat.onclick = () => alert('Чат не реализован');

        div.appendChild(document.createElement('br'));
        div.appendChild(btnTask);
        div.appendChild(btnChat);
        container.appendChild(div);
        container.appendChild(document.createElement('hr'));
      });
    }

    function addTaskForStudent(student) {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.docx';
      fileInput.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('studentID', student.id);
        formData.append('taskName', file.name);

        try {
          const resp = await fetch('/upload-task', {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          const text = await resp.text();
          alert('Ответ сервера:\n' + text);
        } catch (err) {
          alert('Ошибка загрузки файла: ' + err.message);
        }
      };
      fileInput.click();
    }

    // ======== ПРЕПОДАВАТЕЛЬ: ЗАЯВКИ ========
    async function loadRequests() {
      try {
        const res = await fetch('/api/get-requests', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        const reqs = await res.json();
        renderRequests(Array.isArray(reqs) ? reqs : []);
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    function renderRequests(reqs) {
      const container = document.getElementById('requestsList');
      container.innerHTML = '';
      if (!reqs.length) {
        container.textContent = 'Нет заявок';
        return;
      }
      reqs.forEach(r => {
        // r.teacherID, r.id, r.fio, r.age ...
        const div = document.createElement('div');
        div.textContent = `ФИО: ${r.fio}, Возраст: ${r.age}`;

        const btnConfirm = document.createElement('button');
        btnConfirm.textContent = 'Принять';
        btnConfirm.onclick = () => confirmRequest(r);

        const btnDeny = document.createElement('button');
        btnDeny.textContent = 'Отклонить';
        btnDeny.onclick = () => denyRequest(r);

        div.appendChild(document.createElement('br'));
        div.appendChild(btnConfirm);
        div.appendChild(btnDeny);
        container.appendChild(div);
        container.appendChild(document.createElement('hr'));
      });
    }

    async function confirmRequest(r) {
      try {
        const url = '/api/confirm?studentID=' + encodeURIComponent(r.id);
        const res = await fetch(url, {
          method: 'POST',
          credentials: 'include'
        });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка подтверждения: ' + text);
          return;
        }
        alert('Заявка принята');
        loadRequests(); // обновим список
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    async function denyRequest(r) {
      try {
        // /api/deny?teacherID=...&studentID=...
        const url = '/api/deny?studentID=' + encodeURIComponent(r.id);
        const res = await fetch(url, {
          method: 'POST',
          credentials: 'include'
        });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка отклонения: ' + text);
          return;
        }
        alert('Заявка отклонена');
        loadRequests();
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    // ======== ОБЩИЕ: Задания ========
    async function loadTasks() {
      try {
        const res = await fetch('/api/get-tasks', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        const tasks = await res.json();
        renderTasks(Array.isArray(tasks) ? tasks : []);
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasksList');
      container.innerHTML = '';
      if (!tasks.length) {
        container.textContent = 'Заданий нет';
        return;
      }
      tasks.forEach(t => {
        let info = `Название: ${t.taskName}, Статус: ${t.status}`;
        if (typeof t.grade !== 'undefined') {
          info += `, Оценка: ${t.grade}`;
        }
        const div = document.createElement('div');
        div.textContent = info;
        container.appendChild(div);
        container.appendChild(document.createElement('hr'));
      });
    }

    // ======== ОБЩИЕ: Профиль ========
    async function loadProfile() {
      try {
        const res = await fetch('/api/get-profile', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        const user = await res.json();
        renderProfile(user);
      } catch (err) {
        alert('Ошибка загрузки профиля: ' + err.message);
      }
    }

    function renderProfile(user) {
      const container = document.getElementById('profileInfo');
      container.innerHTML = '';

      if (!user || typeof user.fio !== 'string' || user.fio.trim() === '') {
        container.textContent = 'Профиль не заполнен';
        return;
      }

      let html = `
        <p><strong>ФИО:</strong> ${user.fio}</p>
        <p><strong>Возраст:</strong> ${user.age}</p>
      `;
      if (user.specialty) {
        html += `<p><strong>Специализация:</strong> ${user.specialty}</p>`;
      }
      if (typeof user.price === 'number') {
        html += `<p><strong>Цена:</strong> ${user.price}</p>`;
      }
      if (typeof user.rating === 'number') {
        html += `<p><strong>Рейтинг:</strong> ${user.rating}</p>`;
      }
      container.innerHTML = html;
    }

    // ======== СТУДЕНТ: Все преподаватели ========
    async function loadAllTeachers() {
      const sortField = document.getElementById('sortField').value;
      const sortOrder = document.getElementById('sortOrder').value;

      try {
        const res = await fetch('/api/get-teachers', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        let teachers = await res.json();
        if (!Array.isArray(teachers)) teachers = [];

        teachers.sort((a, b) => {
          if (sortField === 'price' || sortField === 'rating') {
            if (sortOrder === 'asc') return a[sortField] - b[sortField];
            return b[sortField] - a[sortField];
          }
          return 0; // если другое поле – не сортируем
        });

        renderAllTeachers(teachers);
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    function renderAllTeachers(teachers) {
      const container = document.getElementById('allTeachersList');
      container.innerHTML = '';
      if (!teachers.length) {
        container.textContent = 'Нет преподавателей';
        return;
      }
      teachers.forEach(t => {
        const div = document.createElement('div');
        div.textContent = `ФИО: ${t.fio}, Возраст: ${t.age}, Цена: ${t.price}, Рейтинг: ${t.rating}`;

        const btnReq = document.createElement('button');
        btnReq.textContent = 'Отправить заявку';
        btnReq.onclick = () => sendRequestToTeacher(t);

        div.appendChild(document.createElement('br'));
        div.appendChild(btnReq);
        container.appendChild(div);
        container.appendChild(document.createElement('hr'));
      });
    }

    async function sendRequestToTeacher(teacher) {
      // Тут teacherID в query
      const url = '/api/send-request?teacherID=' + encodeURIComponent(teacher.id);
      try {
        const res = await fetch(url, {
          method: 'POST',
          credentials: 'include'
        });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        const reply = await res.json();
        alert('Заявка отправлена: ' + JSON.stringify(reply));
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    // ======== СТУДЕНТ: Мои преподаватели ========
    async function loadMyTeachers() {
      try {
        const res = await fetch('/api/get-my-teachers', { credentials: 'include' });
        if (!res.ok) {
          const text = await res.text();
          alert('Ошибка сервера: ' + text);
          return;
        }
        let teachers = await res.json();
        if (!Array.isArray(teachers)) teachers = [];
        renderMyTeachers(teachers);
      } catch (err) {
        alert('Ошибка сети: ' + err.message);
      }
    }

    function renderMyTeachers(teachers) {
      const container = document.getElementById('myTeachersList');
      container.innerHTML = '';
      if (!teachers.length) {
        container.textContent = 'Преподавателей нет';
        return;
      }
      teachers.forEach(t => {
        const div = document.createElement('div');
        div.textContent = `ФИО: ${t.fio}, Возраст: ${t.age}`;

        const btnChat = document.createElement('button');
        btnChat.textContent = 'Начать чат';
        btnChat.onclick = () => alert('Чат не реализован');

        div.appendChild(document.createElement('br'));
        div.appendChild(btnChat);
        container.appendChild(div);
        container.appendChild(document.createElement('hr'));
      });
    }
  </script>
</body>
</html>
